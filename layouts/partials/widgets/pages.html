{{/* Publications/Talks widget adapted for Evangelion theme */}}

{{ $ := .root }}
{{ $page := .page }}
{{ $columns := $page.Params.design.columns | default "2" }}

<div class="eva-terminal">
  <!-- Terminal header -->
  <div class="terminal-header">
    <span class="terminal-title">{{ if eq $page.Params.content.page_type "publication" }}RESEARCH_DATABASE{{ else }}PRESENTATION_ARCHIVES{{ end }}</span>
    <div class="terminal-controls">
      <span class="status status-cyan"></span>
      <span class="status status-orange"></span>
      <span class="status status-green"></span>
    </div>
  </div>

  <!-- Terminal content -->
  <div class="terminal-content">
    <div class="terminal-prompt">> ACCESS {{ if eq $page.Params.content.page_type "publication" }}PUBLICATIONS{{ else }}TALKS{{ end }}</div>
    
    <h1 class="terminal-heading">{{ with $page.Title }}{{ . | markdownify }}{{ end }}</h1>
    
    {{ with $page.Content }}<div class="terminal-intro">{{ . }}</div>{{ end }}
    
    {{ if $page.Params.content.filters.tag }}
      {{ warnf "The `tag` filter has been renamed to `tags`." }}
      {{ $page.Params.content.filters.tags = $page.Params.content.filters.tag }}
    {{ end }}

    {{ $query := where site.RegularPages "Type" $page.Params.content.page_type }}
    {{ with $page.Params.content.filters.tags }}
      {{ $query = $query | intersect (site.RegularPages | filter .tags) }}
    {{ end }}
    {{ with $page.Params.content.filters.category }}
      {{ $query = $query | intersect (site.RegularPages | filter .categories) }}
    {{ end }}
    {{ with $page.Params.content.filters.publication_type }}
      {{ $query = $query | intersect (site.RegularPages | filter .publication_types) }}
    {{ end }}
    {{ with $page.Params.content.filters.author }}
      {{ $query = $query | intersect (site.RegularPages | filter "author" .) }}
    {{ end }}
    {{ with $page.Params.content.filters.exclude_featured }}
      {{ $query = $query | filter "featured" false }}
    {{ end }}
    {{ with $page.Params.content.filters.exclude_past }}
      {{ $query = $query | intersect (site.RegularPages | filter "date" (now.Format "2006-01-02") "ge") }}
    {{ end }}
    {{ with $page.Params.content.filters.exclude_future }}
      {{ $query = $query | intersect (site.RegularPages | filter "date" (now.Format "2006-01-02") "le") }}
    {{ end }}
    
    {{ $count := len $query }}
    
    {{/* Sort by Title or Date */}}
    {{ $sort_by := $page.Params.content.sort_by | default "date" }}
    {{ $sort_ascending := $page.Params.content.sort_ascending | default (eq $sort_by "title") }}
    {{ $sort_order := cond $sort_ascending "asc" "desc" }}
    {{ $sorted_pages := sort $query $sort_by $sort_order }}

    {{/* Limit */}}
    {{ $limit := $page.Params.content.count }}
    {{ if eq $limit 0 }}
      {{ $limit = $count }}
    {{ end }}

    <div class="pubs-container">
      {{ range first $limit $sorted_pages }}
        {{ if eq $page.Params.content.view 1 }}
          {{ partial "li_list" . }}
        {{ else if eq $page.Params.content.view 3 }}
          {{ partial "li_card" . }}
        {{ else if eq $page.Params.content.view 4 }}
          {{ partial "li_citation" . }}
        {{ else }}
          {{ partial "li_compact" . }}
        {{ end }}
      {{ end }}
    </div>

    {{/* Show more link if needed */}}
    {{ if and $page.Params.content.link_to_archive (gt $count $limit) }}
      <div class="see-all">
        <a href="{{ $page.Params.content.link_to_archive | relLangURL }}" class="see-all-link">
          {{ i18n "more_pages" | default "See all" }}
          <i class="fas fa-angle-right"></i>
        </a>
      </div>
    {{ end }}
  </div>
</div>